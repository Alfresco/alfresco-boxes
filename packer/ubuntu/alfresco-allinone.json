{
    "builders": [
        {
            "access_key": "{{user `aws_access_key`}}",
            "ami_name": "alfresco-allinone {{timestamp}}",
            "instance_type": "m1.small",
            "region": "us-west-1",
            "secret_key": "{{user `aws_secret_key`}}",
            "source_ami": "ami-a4e81fd3",
            "ssh_username": "ubuntu",
            "type": "amazon-ebs"
        },
        {
            "boot_command": [
                "<esc><esc><enter><wait>",
                "/install/vmlinuz noapic preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg <wait>",
                "debian-installer=en_US auto locale=en_US kbd-chooser/method=us <wait>",
                "hostname={{ .Name }} <wait>",
                "fb=false debconf/frontend=noninteractive <wait>",
                "keyboard-configuration/modelcode=SKIP keyboard-configuration/layout=USA keyboard-configuration/variant=USA console-setup/ask_detect=false <wait>",
                "initrd=/install/initrd.gz -- <enter><wait>"
            ],
            "boot_wait": "4s",
            "guest_additions_path": "VBoxGuestAdditions_{{.Version}}.iso",
            "guest_os_type": "Ubuntu_64",
            "headless": false,
            "http_directory": "../common/http",
            "iso_checksum": "4d1a8b720cdd14b76ed9410c63a00d0e",
            "iso_checksum_type": "md5",
            "iso_url": "http://releases.ubuntu.com/13.10/ubuntu-13.10-server-amd64.iso",
            "shutdown_command": "echo 'shutdown -P now' > shutdown.sh; echo 'vagrant'|sudo -S sh 'shutdown.sh'",
            "ssh_password": "vagrant",
            "ssh_port": 22,
            "ssh_username": "vagrant",
            "ssh_wait_timeout": "10000s",
            "type": "virtualbox-iso",
            "vboxmanage": [
                [
                    "modifyvm",
                    "{{.Name}}",
                    "--memory",
                    "2048"
                ],
                [
                    "modifyvm",
                    "{{.Name}}",
                    "--cpus",
                    "4"
                ],
                [
                    "modifyvm",
                    "{{.Name}}",
                    "--nic1",
                    "nat"
                ]

            ],
            "virtualbox_version_file": ".vbox_version"
        }
    ],
    "provisioners": [
        {
            "cookbook_paths": [
                "../common/vendor-cookbooks"
            ],
            "execute_command": "echo 'vagrant' | {{if .Sudo}}sudo -S{{end}} chef-solo --no-color -c {{.ConfigPath}} -j {{.JsonPath}} -l debug",
            "install_command": "echo 'vagrant' | {{if .Sudo}}sudo -S{{end}} bash -c 'curl -L https://www.opscode.com/chef/install.sh| bash -s -- -v 11.8'",
            "json": {
                "alfresco": {
                    "properties" : {
                        "index.subsystem.name": "solr",
                        "solr.secureComms": "none"
                    },
                    "solrproperties" : {
                        "alfresco.secureComms": "none"
                    },
                    "maven": {
                        "repo_type": "public"
                    }
                },
                "artifacts": {
                    "alfresco": {
                        "enabled": true,
                        "artifactId": "alfresco-nossl",
                        "groupId": "it.session.alfresco",
                        "version": "4.2.f"
                    },
                    "alfresco-mmt": {
                        "enabled": true
                    },
                    "alfresco-spp": {
                        "enabled": true
                    },
                    "mysqlconnector": {
                        "enabled": true
                    },
                    "share": {
                        "enabled": true
                    },
                    "solr": {
                        "enabled": true,
                        "artifactId": "apache-solr-nossl",
                        "groupId": "it.session.alfresco",
                        "version": "1.4.1-alfresco-patched"
                    },
                    "solrhome": {
                        "enabled": true
                    }
                },
                "hostname": "alfresco-allinone",
                "ip": "192.168.0.23",
                "java": {
                    "default": true,
                    "install_flavor": "oracle",
                    "jdk_version": "7",
                    "oracle": {
                        "accept_oracle_download_terms": true
                    }
                },
                "maven": {
                    "repos": {
                        "maoo-public-cloudbees": {
                            "url": "https://repository-maoo.forge.cloudbees.com/release"
                        }
                    }
                },
                "tomcat": {
                    "base_version": 7,
                    "group": "tomcat7",
                    "java_options": "-Xmx1500M -XX:MaxPermSize=256M -Dsolr.solr.home=/var/lib/tomcat7/alf_data/solrhome",
                    "user": "tomcat7"
                }
            },
            "prevent_sudo": false,
            "run_list": [
                "apt::default",
                "iptables::default",
                "alfresco::3rdparty",
                "alfresco::mysql_server",
                "alfresco::mysql_createdb",
                "tomcat::default",
                "alfresco::repo_config",
                "alfresco::share_config",
                "artifact-deployer::default",
                "alfresco::solr_config",
                "alfresco::apply_amps"
            ],
            "skip_install": false,
            "type": "chef-solo"
        },
        {
            "execute_command": "echo 'vagrant' | sudo -S sh '{{ .Path }}'",
            "inline": [
                "apt-get update -y",
                "apt-get install -y linux-headers-$(uname -r) build-essential dkms",
                "apt-get clean",
                "mount -o loop VBoxGuestAdditions.iso /media/cdrom",
                "sh /media/cdrom/VBoxLinuxAdditions.run",
                "umount /media/cdrom",
                "mkdir ~/.ssh",
                "wget -qO- https://raw.github.com/mitchellh/vagrant/master/keys/vagrant.pub >> ~/.ssh/authorized_keys",
                "echo 'vagrant ALL=NOPASSWD:ALL' > /tmp/vagrant",
                "chmod 0440 /tmp/vagrant",
                "mv /tmp/vagrant /etc/sudoers.d/"
            ],
            "type": "shell"
        }
    ],
    "variables": {
        "aws_access_key": "",
        "aws_secret_key": ""
    }
}
