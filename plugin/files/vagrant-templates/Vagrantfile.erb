Vagrant.configure("2") do |config|

  <% nodes.each do |node_name,node| %>
    <% box_attrs = @engine.get_node_attrs(@params.work_dir, node_name) %>
    box_ip = "<%= node['local-run']['ip'] == nil ? "" : node['local-run']['ip']%>"
    host_name = "<%= box_attrs["hostname"] || box_attrs["name"] %>"

    print "Spinning up <%= node_name %> Vagrant instance on IP `#{box_ip}`(~ 30 minutes run)\n"
    config.vm.define "<%= node_name %>" do |machineConf|

	    machineConf.vm.synced_folder ".", "/vagrant", mount_options: ["dmode=777", "fmode=666"]
	    if !box_ip.empty?
	    	machineConf.vm.network :private_network, ip: box_ip
	    end
	    machineConf.vm.hostname = host_name

	    machineConf.vm.provider :virtualbox do |vb,override|
	      override.vm.box_url = "<%= @params.box_url %>"
	      override.vm.box = "<%= "#{@params.box_name }" %>"
	      vb.customize ["modifyvm", :id, "--memory", <%= node['local-run']['memory'] %>]
	      vb.customize ["modifyvm", :id, "--cpus", <%= node['local-run']['cpus'] %>]
	    end

	    machineConf.vm.provision :chef_solo do |chef|
	      chef.cookbooks_path = "<%= "#{ @params.work_dir }/cookbooks" %>"
	      chef.data_bags_path = "<%= "#{ @params.work_dir }/data_bags" %>"

	      <% box_attrs['run_list'].each do |recipe| %>
	        chef.add_recipe "<%= "recipe[#{recipe}]" %>"
	      <% end %>

	      chef.json = <%= box_attrs %>
	    end
	  end
  <% end %>
end
